DROP FUNCTION IF EXISTS calc_dirc(a geometry);
CREATE FUNCTION calc_dirc(a geometry)
RETURNS text
AS 
$$
	SELECT (CASE WHEN ((ST_Azimuth(ST_StartPoint(a), ST_LineInterpolatePoint(a, 0.2)) + 0.292) BETWEEN pi()/4 and 3*pi()/4) OR ((ST_Azimuth(ST_StartPoint(a), ST_LineInterpolatePoint(a,0.2)) + 0.292)  BETWEEN 5*pi()/4 and 7*pi()/4)
			THEN 'EW'
			ELSE 'NS'
		END);
$$
LANGUAGE SQL IMMUTABLE STRICT;

DROP FUNCTION IF EXISTS calc_side_ew(a geometry, b geometry);
CREATE FUNCTION calc_side_ew(a geometry, b geometry)
RETURNS text
AS
$$
	SELECT (CASE FLOOR((ST_Azimuth(a, ST_LineInterpolatePoint(b, 0.2)) + 0.292)  / (pi()/4)) 
			WHEN 0 THEN 'E'
			WHEN 1 THEN 'E'
			WHEN 2 THEN 'E'
			WHEN 3 THEN 'E'
			WHEN 8 THEN 'E'
			--WHEN 4,5,6,7 THEN 'W'
			ELSE 'W'
		END);
$$
LANGUAGE SQL IMMUTABLE STRICT;

DROP FUNCTOIN IF EXISTS calc_side_ns(a geometry, b geometry);
CREATE FUNCTION calc_side_ns(a geometry, b geometry)
RETURNS text
AS
$$
	SELECT (CASE FLOOR((ST_Azimuth(a, ST_LineInterpolatePoint(b,0.2)) + 0.292)  / (pi()/4)) 
			WHEN 0 THEN 'N'
			WHEN 1 THEN 'N'
			WHEN 6 THEN 'N'
			WHEN 7 THEN 'N'
			WHEN 8 THEN 'N'
			--WHEN 2,3,4,5 THEN 'S' 
			ELSE 'S'
		END);
$$ 
LANGUAGE SQL IMMUTABLE STRICT;